<!DOCTYPE html>
<html lang="en" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XDC Peacock - Post-Quantum Onchain Communication</title>
    <!-- MIT License -->
    <meta name="license" content="MIT">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(180deg, #2E2A6A 0%, #4A3E8A 100%);
            --card-bg: rgba(255, 255, 255, 0.08);
            --text: #F3E8FF;
            --text-secondary: #E2D1F9;
            --text-muted: #D4C2F0;
            --border: rgba(255, 255, 255, 0.15);
            --input-bg: #2E2A6A;
            --btn-bg: #2E2A6A;
            --btn-text: #A3E4FF;
            --success: #6EE7B7;
            --error: #FCA5A5;
            --nav-bg: rgba(46, 42, 106, 0.7);
        }
        [data-theme="dark"] {
            --bg-gradient: linear-gradient(180deg, #0f0f23 0%, #1a1a2e 100%);
            --card-bg: rgba(255, 255, 255, 0.05);
            --text: #e0e0ff;
            --text-secondary: #c0c0ff;
            --text-muted: #a0a0d0;
            --border: rgba(255, 255, 255, 0.1);
            --input-bg: #1a1a2e;
            --btn-bg: #1a1a2e;
            --btn-text: #a0a0ff;
            --nav-bg: rgba(26, 26, 46, 0.7);
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            color: var(--text);
            margin: 0;
            overflow-x: hidden;
            transition: background 0.3s ease;
        }
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            backdrop-filter: blur(6px);
            border-radius: 20px;
            padding: 1.25rem;
        }
        input, textarea {
            background: var(--input-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .btn {
            background: var(--btn-bg);
            color: var(--btn-text);
            border: 1px solid var(--border);
        }
        .success { color: var(--success); }
        .error { color: var(--error); }
        .hidden { display: none; }
        .link { 
            color: #A3E4FF; 
            text-decoration: underline; 
            font-size: 0.75rem; 
            display: inline-block;
            margin-right: auto;
        }
        .link:hover { text-decoration: none; }
        .footer-links {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            font-size: 0.75rem;
        }
        #hero {
            position: relative;
        }
        #background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--text-muted);
            border-radius: 50%;
            opacity: 0.2;
            pointer-events: none;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .hover-effect:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(163, 228, 255, 0.2);
            transition: all 0.3s ease;
        }
        .optional-text {
            font-size: 0.875rem; /* text-sm */
            color: var(--text-muted);
        }
        .output {
            margin-top: 15px;
            padding: 10px;
            background-color: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            word-break: break-all;
            color: var(--text-muted);
        }
        .note {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 15px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
    <!-- Dark Mode Toggle -->
    <div class="fixed top-4 right-4 z-50">
        <button onclick="toggleTheme()" class="bg-[#2E2A6A] text-[#A3E4FF] p-2 rounded-full hover:bg-[#3A3570] transition-all">
            <i id="themeIcon" class="fas fa-moon"></i>
        </button>
    </div>

    <!-- Navigation -->
    <nav class="py-6 px-6 sticky top-0 z-40 bg-opacity-70 backdrop-blur-md" style="background: var(--nav-bg);">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold text-[#F3E8FF] max-sm:text-xl">XDC Peacock</h1>
            <div class="nav-items space-x-8 max-sm:space-x-4 flex items-center">
                <a href="https://github.com/s4njk4n/XDC_Peacock" target="_blank" class="text-[#A3E4FF] hover:text-white font-medium text-lg max-sm:text-sm flex items-center gap-1.5 whitespace-nowrap"><i class="fas fa-book-open text-sm"></i><span>Instructions</span></a>
                <a href="https://www.xdcoutpost.xyz" class="text-[#F3E8FF] hover:text-[#A3E4FF] text-lg max-sm:text-sm">Back to Outpost</a>
                <a href="#contact" class="text-[#F3E8FF] hover:text-[#A3E4FF] text-lg max-sm:text-sm">Contact</a>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section id="hero">
        <div id="background">
            <div id="particles"></div>
        </div>
        <div class="max-w-5xl mx-auto p-6">
            <p class="text-xl md:text-2xl text-[#E2D1F9] mb-12 max-sm:text-base">Secure your messages on the XDC network with quantum-resistant encryption. All operations are client-side for maximum privacy.</p>

            <!-- Key Generation Card -->
            <div class="card hover-effect max-w-lg mx-auto mb-8 p-6">
                <h2 class="text-2xl font-bold text-[#A3E4FF] mb-4">1. Generate Post-Quantum Keypair</h2>
                <p class="text-sm text-[#D4C2F0] mb-4">Generate an ML-KEM-768 keypair for encryption. Copy the keys securely.</p>
                <button onclick="generateKeypair()" class="w-full bg-gradient-to-r from-[#A3E4FF] to-[#FFD1DC] text-[#2E2A6A] font-semibold py-3 px-6 rounded-full hover-effect max-sm:py-2 max-sm:text-sm">Generate Keypair</button>
                <div id="publicKey" class="output mt-4"></div>
                <div id="privateKey" class="output mt-4"></div>
            </div>

            <!-- Send Message Card -->
            <div class="card hover-effect max-w-lg mx-auto mb-8 p-6">
                <h2 class="text-2xl font-bold text-[#A3E4FF] mb-4">2. Encrypt and Send Message</h2>
                <p class="text-sm text-[#D4C2F0] mb-4">Enter details, encrypt the message, and send as transaction data on XDC.</p>
                <label for="toAddr" class="text-sm text-[#D4C2F0] mb-2 block">To Address (xdc... or 0x..., optional):</label>
                <input id="toAddr" placeholder="e.g., xdc123... or 0x123... (leave blank for data-only to null address)" class="w-full p-3 mb-4 rounded-lg bg-[#2E2A6A] text-[#F3E8FF] border border-[#A3E4FF]/30 focus:outline-none max-sm:text-sm">
                <p class="note">Leave blank to send to the null address (0x000...000) for pure data storage without transferring value to another account. This avoids errors when including data in transactions to regular accounts.</p>

                <label for="pubKey" class="text-sm text-[#D4C2F0] mb-2 block">Recipient's Public Key (hex):</label>
                <textarea id="pubKey" rows="4" placeholder="Paste public key here" class="w-full p-3 mb-4 rounded-lg bg-[#2E2A6A] text-[#F3E8FF] border border-[#A3E4FF]/30 focus:outline-none max-sm:text-sm"></textarea>

                <label for="message" class="text-sm text-[#D4C2F0] mb-2 block">Message to Encrypt:</label>
                <textarea id="message" rows="4" placeholder="Enter your message" class="w-full p-3 mb-4 rounded-lg bg-[#2E2A6A] text-[#F3E8FF] border border-[#A3E4FF]/30 focus:outline-none max-sm:text-sm"></textarea>

                <label for="amount" class="text-sm text-[#D4C2F0] mb-2 block">Amount of XDC to Send:</label>
                <input id="amount" type="number" value="0" step="any" class="w-full p-3 mb-4 rounded-lg bg-[#2E2A6A] text-[#F3E8FF] border border-[#A3E4FF]/30 focus:outline-none max-sm:text-sm">

                <label for="rpc" class="text-sm text-[#D4C2F0] mb-2 block">RPC Endpoint:</label>
                <input id="rpc" value="https://rpc.ankr.com/xdc" class="w-full p-3 mb-4 rounded-lg bg-[#2E2A6A] text-[#F3E8FF] border border-[#A3E4FF]/30 focus:outline-none max-sm:text-sm">

                <div class="flex gap-4">
                    <button onclick="connectWallet()" class="flex-1 bg-gradient-to-r from-[#A3E4FF] to-[#FFD1DC] text-[#2E2A6A] font-semibold py-3 px-6 rounded-full hover-effect max-sm:py-2 max-sm:text-sm">Connect MetaMask</button>
                    <button onclick="sendMessage()" class="flex-1 bg-gradient-to-r from-[#A3E4FF] to-[#FFD1DC] text-[#2E2A6A] font-semibold py-3 px-6 rounded-full hover-effect max-sm:py-2 max-sm:text-sm">Send Message</button>
                </div>
                <div id="txStatus" class="output mt-4"></div>
            </div>

            <!-- Decrypt Message Card -->
            <div class="card hover-effect max-w-lg mx-auto p-6">
                <h2 class="text-2xl font-bold text-[#A3E4FF] mb-4">3. Decrypt Message from Transaction</h2>
                <p class="text-sm text-[#D4C2F0] mb-4">Enter the transaction hash and your private key to fetch and decrypt the message.</p>
                <label for="txHashInput" class="text-sm text-[#D4C2F0] mb-2 block">Transaction Hash:</label>
                <input id="txHashInput" placeholder="e.g., 0xabc..." class="w-full p-3 mb-4 rounded-lg bg-[#2E2A6A] text-[#F3E8FF] border border-[#A3E4FF]/30 focus:outline-none max-sm:text-sm">

                <label for="privKey" class="text-sm text-[#D4C2F0] mb-2 block">Your Private Key (hex):</label>
                <textarea id="privKey" rows="4" placeholder="Paste private key here" class="w-full p-3 mb-4 rounded-lg bg-[#2E2A6A] text-[#F3E8FF] border border-[#A3E4FF]/30 focus:outline-none max-sm:text-sm"></textarea>

                <label for="rpcDecrypt" class="text-sm text-[#D4C2F0] mb-2 block">RPC Endpoint:</label>
                <input id="rpcDecrypt" value="https://rpc.ankr.com/xdc" class="w-full p-3 mb-4 rounded-lg bg-[#2E2A6A] text-[#F3E8FF] border border-[#A3E4FF]/30 focus:outline-none max-sm:text-sm">

                <button onclick="decryptMessage()" class="w-full bg-gradient-to-r from-[#A3E4FF] to-[#FFD1DC] text-[#2E2A6A] font-semibold py-3 px-6 rounded-full hover-effect max-sm:py-2 max-sm:text-sm">Decrypt Message</button>
                <div id="decryptedMessage" class="output mt-4"></div>
            </div>
        </div>
    </section>

    <!-- Contact Section -->
    <section id="contact" class="pt-20 pb-4 px-6">
        <div class="max-w-5xl mx-auto text-center">
            <h2 class="text-4xl md:text-5xl font-bold text-[#A3E4FF] mb-12 max-sm:text-2xl">Connect</h2>
            <p class="text-[#E2D1F9] mb-8 text-lg max-sm:text-sm">Have questions or need support for XDC Peacock or other services? Reach out on your preferred platform:</p>
            <div class="social-links flex justify-center flex-wrap gap-8 max-sm:gap-4">
                <a href="https://t.me/s4njk4n" target="_blank" class="social-icon text-3xl max-sm:text-xl" aria-label="Contact on Telegram" title="Contact on Telegram (@s4njk4n)">
                    <i class="fa-brands fa-telegram"></i> <span class="text-lg max-sm:text-sm ml-2">Telegram: @s4njk4n</span>
                </a>
                <a href="https://discord.com/users/852434672793288724" target="_blank" class="social-icon text-3xl max-sm:text-xl" aria-label="Contact on Discord" title="Contact on Discord (@s4njk4n)">
                    <i class="fa-brands fa-discord"></i> <span class="text-lg max-sm:text-sm ml-2">Discord: @s4njk4n</span>
                </a>
                <a href="https://x.com/s4njk4n" target="_blank" class="social-icon text-3xl max-sm:text-xl" aria-label="Visit X profile" title="Visit X profile (@s4njk4n)">
                    <i class="fa-brands fa-x-twitter"></i> <span class="text-lg max-sm:text-sm ml-2">X: @s4njk4n</span>
                </a>
                <a href="https://github.com/s4njk4n" target="_blank" class="social-icon text-3xl max-sm:text-xl" aria-label="Visit GitHub profile" title="Visit GitHub profile (s4njk4n)">
                    <i class="fa-brands fa-github"></i> <span class="text-lg max-sm:text-sm ml-2">GitHub: s4njk4n</span>
                </a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="py-10 px-6 text-center text-[#D4C2F0]">
        <p class="max-sm:text-sm">Â© 2025 XDC Outpost. All rights reserved. Powered by <a href="https://github.com/s4njk4n?tab=repositories" target="_blank" class="text-[#A3E4FF] hover:underline">s4njk4n</a>.</p>
        <p class="mt-2">
            <a href="https://www.hitwebcounter.com/" target="_blank">
                <img src="https://hitwebcounter.com/counter/counter.php?page=21461826&style=0038&nbdigits=5&type=page&initCount=0" title="Free Tools" alt="Free Tools" border="0" style="display: block; margin: 0 auto;" />
            </a>
        </p>    
    </footer>

    <script>
        // === Theme Toggle ===
        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');
            if (html.hasAttribute('data-theme')) {
                html.removeAttribute('data-theme');
                icon.classList.replace('fa-sun', 'fa-moon');
                localStorage.setItem('theme', 'light');
            } else {
                html.setAttribute('data-theme', 'dark');
                icon.classList.replace('fa-moon', 'fa-sun');
                localStorage.setItem('theme', 'dark');
            }
        }
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('themeIcon').classList.replace('fa-moon', 'fa-sun');
        }

        // === Animations ===
        const particlesContainer = document.getElementById('particles');
        function initParticles() {
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = `${Math.random() * 100}%`;
                p.style.top = `${Math.random() * 100}%`;
                p.style.animation = `float ${5 + Math.random() * 3}s infinite`;
                particlesContainer.appendChild(p);
            }
        }
        initParticles();

        function randomizeClouds() {
            const bg = document.querySelector('#background');
            const rand = () => 20 + Math.random() * 60;
            bg.style.setProperty('--cloud1-left', `${rand()}%`);
            bg.style.setProperty('--cloud2-left', `${rand()}%`);
            bg.style.setProperty('--cloud1-top', `${rand()}%`);
            bg.style.setProperty('--cloud2-top', `${rand()}%`);
        }
        randomizeClouds();
        setInterval(randomizeClouds, 10000);

        window.onload = () => {
            initParticles();
            randomizeClouds();
            setInterval(randomizeClouds, 10000);
        };

        // Peacock-specific script
        let provider;
        const MLKEM_VARIANT = 'MlKem768';
        const CT_SIZE = 1088; // For ML-KEM-768
        const IV_SIZE = 12;

        function arrayToHex(arr) {
            return Array.from(arr, b => b.toString(16).padStart(2, '0')).join('');
        }

        function hexToArray(hex) {
            return new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
        }

        function concatArrays(arrays) {
            const totalLen = arrays.reduce((len, arr) => len + arr.length, 0);
            const result = new Uint8Array(totalLen);
            let offset = 0;
            for (let arr of arrays) {
                result.set(arr, offset);
                offset += arr.length;
            }
            return result;
        }

        async function getMlKemClass() {
            const { [MLKEM_VARIANT]: MlKemClass } = await import('https://esm.sh/mlkem');
            return MlKemClass;
        }

        async function generateKeypair() {
            try {
                const MlKemClass = await getMlKemClass();
                const instance = new MlKemClass();
                const [pk, sk] = await instance.generateKeyPair();
                document.getElementById('publicKey').innerText = 'Public Key (hex):\n' + arrayToHex(pk);
                document.getElementById('privateKey').innerText = 'Private Key (hex):\n' + arrayToHex(sk);
            } catch (error) {
                alert('Error generating keypair: ' + error.message);
            }
        }

        async function connectWallet() {
            if (!window.ethereum) return alert('MetaMask not detected');
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const network = await provider.getNetwork();
                if (network.chainId !== 50) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x32',
                            chainName: 'XDC Network',
                            rpcUrls: ['https://rpc.ankr.com/xdc'],
                            nativeCurrency: { name: 'XDC', symbol: 'XDC', decimals: 18 },
                            blockExplorerUrls: ['https://explorer.xinfin.network']
                        }]
                    });
                }
                alert('Wallet connected');
            } catch (error) {
                alert('Error connecting wallet: ' + error.message);
            }
        }

        async function sendMessage() {
            if (!provider) return alert('Connect wallet first');
            try {
                let to = document.getElementById('toAddr').value.trim();
                if (to === '') {
                    to = '0x0000000000000000000000000000000000000000';
                } else if (to.startsWith('xdc')) {
                    to = '0x' + to.slice(3);
                }
                const pubKeyHex = document.getElementById('pubKey').value.trim();
                const pk = hexToArray(pubKeyHex);
                const msg = document.getElementById('message').value;
                const amount = document.getElementById('amount').value;

                const MlKemClass = await getMlKemClass();
                const sender = new MlKemClass();
                const [ct, ss] = await sender.encap(pk);
                const key = await crypto.subtle.importKey('raw', ss, 'AES-GCM', true, ['encrypt']);
                const iv = crypto.getRandomValues(new Uint8Array(IV_SIZE));
                const encryptedMsg = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, new TextEncoder().encode(msg));
                const fullData = concatArrays([ct, iv, new Uint8Array(encryptedMsg)]);
                const dataHex = '0x' + arrayToHex(fullData);

                const signer = provider.getSigner();
                const tx = {
                    to,
                    value: ethers.utils.parseEther(amount.toString()),
                    data: dataHex
                };
                const resp = await signer.sendTransaction(tx);
                document.getElementById('txStatus').innerText = 'Transaction Hash: ' + resp.hash + '\nWaiting for confirmation...';
                await resp.wait();
                document.getElementById('txStatus').innerText += '\nConfirmed!';
            } catch (error) {
                alert('Error sending message: ' + error.message);
            }
        }

        async function decryptMessage() {
            try {
                const txHash = document.getElementById('txHashInput').value.trim();
                const privKeyHex = document.getElementById('privKey').value.trim();
                const sk = hexToArray(privKeyHex);
                const rpc = document.getElementById('rpcDecrypt').value;

                const queryProvider = new ethers.providers.JsonRpcProvider(rpc);
                const tx = await queryProvider.getTransaction(txHash);
                if (!tx || !tx.data) throw new Error('Invalid transaction');

                const dataBytes = hexToArray(tx.data.slice(2));
                const ct = dataBytes.slice(0, CT_SIZE);
                const iv = dataBytes.slice(CT_SIZE, CT_SIZE + IV_SIZE);
                const encMsg = dataBytes.slice(CT_SIZE + IV_SIZE);

                const MlKemClass = await getMlKemClass();
                const recipient = new MlKemClass();
                const ss = await recipient.decap(ct, sk);
                const key = await crypto.subtle.importKey('raw', ss, 'AES-GCM', true, ['decrypt']);
                const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, encMsg);
                const msg = new TextDecoder().decode(decrypted);

                document.getElementById('decryptedMessage').innerText = 'Decrypted Message:\n' + msg;
            } catch (error) {
                alert('Error decrypting message: ' + error.message);
            }
        }
    </script>
</body>
</html>
